<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Espace Client - LocaFrance</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .dashboard { padding: 40px 0; background: var(--background-gray); min-height: 100vh; }
        .dashboard-header { background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
        .stat-card h3 { color: var(--text-light); font-size: 14px; margin-bottom: 10px; }
        .stat-card .stat-value { font-size: 36px; font-weight: bold; color: var(--primary-color); }
        .reservations-list { background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow); }
        .reservation-item { border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; display: grid; grid-template-columns: 150px 1fr auto; gap: 20px; align-items: center; }
        .reservation-image { width: 150px; height: 100px; border-radius: 8px; object-fit: cover; }
        .reservation-actions { display: flex; gap: 10px; flex-direction: column; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-secondary { background: #e2e3e5; color: #383d41; }
        .etoile { cursor: pointer; color: #ddd; transition: color 0.2s; font-size: 40px; }
        .etoile:hover { color: #ffc107; }
        .etoile.active { color: #FFD700; }
        @media (max-width: 768px) { .reservation-item { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand"><a href="/"><i class="fas fa-home"></i> LocaFrance</a></div>
            <div class="nav-menu">
                <a href="/" class="nav-link">Accueil</a>
                <a href="/pages/messagerie.html" class="nav-link"><i class="fas fa-envelope"></i> Messages</a>
                <a href="/pages/client-dashboard.html" class="nav-link active">Mon espace</a>
                <button class="btn btn-outline" onclick="logout()"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>
            </div>
        </div>
    </nav>

    <div class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>Bienvenue, <span id="userName"></span> üëã</h1>
                <p style="color: var(--text-light);">G√©rez vos r√©servations et trouvez votre prochain logement</p>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>R√©servations actives</h3>
                    <div class="stat-value" id="statActives">0</div>
                </div>
                <div class="stat-card">
                    <h3>En attente</h3>
                    <div class="stat-value" id="statAttente">0</div>
                </div>
                <div class="stat-card">
                    <h3>R√©servations pass√©es</h3>
                    <div class="stat-value" id="statPassees">0</div>
                </div>
            </div>

            <div class="reservations-list">
                <h2 style="margin-bottom: 25px;">Mes R√©servations</h2>
                <div id="reservationsList">
                    <div class="loading"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Avis -->
    <div class="modal" id="avisModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('avisModal')">&times;</span>
            <h2>Laisser un avis public</h2>
            <form id="avisForm" onsubmit="soumettreAvis(event)">
                <div class="form-group">
                    <label>Note *</label>
                    <div style="text-align: center; margin: 20px 0;">
                        <i class="fas fa-star etoile" data-note="1" onclick="selectionnerNote(1)"></i>
                        <i class="fas fa-star etoile" data-note="2" onclick="selectionnerNote(2)"></i>
                        <i class="fas fa-star etoile" data-note="3" onclick="selectionnerNote(3)"></i>
                        <i class="fas fa-star etoile" data-note="4" onclick="selectionnerNote(4)"></i>
                        <i class="fas fa-star etoile" data-note="5" onclick="selectionnerNote(5)"></i>
                    </div>
                    <input type="hidden" id="noteChoisie" required>
                </div>
                
                <div class="form-group">
                    <label>Commentaire public *</label>
                    <textarea name="commentaire" id="commentaireAvis" rows="4" required placeholder="Partagez votre exp√©rience (visible par tous)..."></textarea>
                </div>
                
                <div class="form-error" id="avisError"></div>
                
                <button type="submit" class="btn btn-primary btn-block">Publier l'avis</button>
            </form>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        requireAuth('client');
        let reservationIdPourAvis = null;

        async function chargerDashboard() {
            const user = getCurrentUser();
            document.getElementById('userName').textContent = user.prenom;

            try {
                const reservations = await ReservationsAPI.getMesReservations();
                afficherReservations(reservations);
                calculerStatistiques(reservations);
            } catch (error) {
                showAlert('Erreur lors du chargement des donn√©es', 'error');
                console.error('Erreur dashboard:', error);
            }
        }

        function calculerStatistiques(reservations) {
            const actives = reservations.filter(r => r.statut === 'acceptee' && new Date(r.date_fin) > new Date()).length;
            const attente = reservations.filter(r => r.statut === 'en_attente').length;
            const passees = reservations.filter(r => r.statut === 'acceptee' && new Date(r.date_fin) <= new Date()).length;

            document.getElementById('statActives').textContent = actives;
            document.getElementById('statAttente').textContent = attente;
            document.getElementById('statPassees').textContent = passees;
        }

        function afficherReservations(reservations) {
            const container = document.getElementById('reservationsList');
            
            if (reservations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">Aucune r√©servation</p>';
                return;
            }

            container.innerHTML = reservations.map(r => {
                const statut = getStatutLabel(r.statut);
                const peutAnnuler = r.statut === 'en_attente' || (r.statut === 'acceptee' && new Date(r.date_debut) > new Date());
                const peutAvis = r.statut === 'acceptee';
                
                // ‚úÖ G√®re logement_id ou logement
                const idLogement = r.logement_id || r.logement || 'undefined';
                console.log('üîç R√©servation:', r.id, 'Logement ID:', idLogement);

                return `
                    <div class="reservation-item">
                        <img src="${r.photo_url || 'https://via.placeholder.com/150x100'}" alt="${r.titre}" class="reservation-image" onerror="this.src='https://via.placeholder.com/150x100'">
                        <div>
                            <h3>${r.titre}</h3>
                            <p style="color: var(--text-light); margin: 5px 0;"><i class="fas fa-map-marker-alt"></i> ${r.ville}</p>
                            <p style="margin: 5px 0;"><strong>Du ${formatDate(r.date_debut)} au ${formatDate(r.date_fin)}</strong></p>
                            <p style="margin: 5px 0;">${r.nombre_voyageurs} voyageur(s) ‚Ä¢ ${r.prix_total}‚Ç¨</p>
                            <span class="badge badge-${statut.class}">${statut.text}</span>
                        </div>
                        <div class="reservation-actions">
                            ${peutAnnuler ? `<button class="btn btn-outline" onclick="annulerReservation(${r.id})"><i class="fas fa-times"></i> Annuler</button>` : ''}
                            ${peutAvis ? `<button class="btn btn-primary" onclick="ouvrirModalAvis(${r.id})"><i class="fas fa-star"></i> Laisser un avis</button>` : ''}
                            <button class="btn btn-outline" onclick="window.location.href='/pages/logement-details.html?id=${idLogement}'">Voir le logement</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function annulerReservation(id) {
            if (!confirm('Voulez-vous vraiment annuler cette r√©servation ?')) return;

            try {
                await ReservationsAPI.annuler(id);
                showAlert('R√©servation annul√©e', 'success');
                chargerDashboard();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        function ouvrirModalAvis(reservationId) {
            reservationIdPourAvis = reservationId;
            document.getElementById('noteChoisie').value = '';
            document.getElementById('commentaireAvis').value = '';
            document.querySelectorAll('.etoile').forEach(e => e.classList.remove('active'));
            document.getElementById('avisModal').classList.add('active');
        }

        function selectionnerNote(note) {
            document.getElementById('noteChoisie').value = note;
            
            document.querySelectorAll('.etoile').forEach((etoile, index) => {
                if (index < note) {
                    etoile.classList.add('active');
                } else {
                    etoile.classList.remove('active');
                }
            });
        }

        async function soumettreAvis(event) {
            event.preventDefault();
            
            const note = document.getElementById('noteChoisie').value;
            const commentaire = document.getElementById('commentaireAvis').value;
            
            if (!note) {
                document.getElementById('avisError').textContent = 'Veuillez s√©lectionner une note';
                document.getElementById('avisError').classList.add('active');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:8000/api/reservations/${reservationIdPourAvis}/avis/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        note: parseInt(note),
                        commentaire: commentaire
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    closeModal('avisModal');
                    showAlert('Avis publi√© avec succ√®s !', 'success');
                    chargerDashboard();
                } else {
                    document.getElementById('avisError').textContent = data.error || 'Erreur lors de la publication';
                    document.getElementById('avisError').classList.add('active');
                }
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('avisError').textContent = 'Erreur de connexion';
                document.getElementById('avisError').classList.add('active');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            chargerDashboard();
        });
    </script>
</body>
</html>